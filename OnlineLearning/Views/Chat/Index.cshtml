@model RoleViewModel

<div class="container mt-5">
    <div class="row mb-4">
        <h2 class="text-center">Chat Application</h2>
    </div>
    <div class="row mb-3">
        <div class="col-md-3"><strong>Role:</strong></div>
        <div class="col-md-6 text-primary" id="role">@Model.UserRoles?.FirstOrDefault()</div>
    </div>
    <div class="row mb-3">
        <div class="col-md-3"><strong>Sender:</strong></div>
        <div class="col-md-6">
            <input class="form-control" type="text" value="@User.Identity?.Name" id="senderEmail" disabled />
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-3"><strong>Receiver:</strong></div>
        <div class="col-md-6">
            <input class="form-control" type="text" id="receiverEmail" placeholder="Enter receiver's email" />
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-3"><strong>Message:</strong></div>
        <div class="col-md-6">
            <input class="form-control" type="text" id="chatMessage" placeholder="Type your message" />
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6">
            <button class="btn btn-primary" id="sendMessage">Send Message</button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-secondary" id="sendMessageToGroup">Send Message to Group</button>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <hr />
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-12">
            <h5>Messages:</h5>
            <ul id="messagesList" class="list-group"></ul>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.js"></script>

<script>
    var connectionChat = new signalR.HubConnectionBuilder().withUrl("/ChatHub").build();

    document.getElementById("sendMessage").disabled = false;

    // Listen for the MessageReceived event from SignalR
    connectionChat.on("MessageReceived", function (user, message) {
        var li = document.createElement("li");
        li.classList.add("list-group-item");
        var senderEmail = document.getElementById("senderEmail").value; // Current sender's email

        // Check if the sender is the current user
        if (user === senderEmail) {
            li.textContent = `You: ${message}`; // If it's the current sender
            li.classList.add("list-group-item-info"); // Optional: Add a different style for self messages
        } else {
            li.textContent = `${user}: ${message}`; // If not the current sender
        }

        document.getElementById("messagesList").appendChild(li);
    });

    document.getElementById("sendMessage").addEventListener("click", function (event) {
        var sender = document.getElementById("senderEmail").value;
        var message = document.getElementById("chatMessage").value;
        var receiver = document.getElementById("receiverEmail").value;

        if (receiver.length > 0) {
            // If there is a receiver, send the message to that user
            $.ajax({
                url: '/SendMessageToReceiver',
                type: 'GET',
                data: { sender: sender, receiver: receiver, message: message },
                success: function (response) {
                    console.log(response);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        } else {
            // If no receiver, send the message to all users
            $.ajax({
                url: '/SendMessageToAll',
                type: 'GET',
                data: { user: sender, message: message },
                success: function (response) {
                    console.log(response);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        }

        // Display the sent message in the list immediately
        var li = document.createElement("li");
        li.classList.add("list-group-item", "list-group-item-info");
        li.textContent = `You: ${message}`; // Display the sender's name
        document.getElementById("messagesList").appendChild(li); // Add the message to the list
        document.getElementById("chatMessage").value = ""; // Clear the message input
        event.preventDefault(); // Prevent the default behavior of the button
    });

    document.getElementById("sendMessageToGroup").addEventListener("click", function (event) {
        var message = document.getElementById("chatMessage").value;

        $.ajax({
            url: '/SendMessageToGroup',
            type: 'GET',
            data: { message: message },
            success: function (response) {
                console.log(response);
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });

        event.preventDefault(); // Prevent the default behavior of the button
    });

    connectionChat.start().then(function () {
        var sender = document.getElementById("senderEmail").value;
        connectionChat.send("JoinGroup", sender);
        document.getElementById("sendMessage").disabled = false; // Enable the send message button
    });
</script>

